<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.jpg">
  <link rel="mask-icon" href="/images/favicon.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CRoboto+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-fill-left.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"left","width":310,"display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>


<meta name="description" content="Modules 模块NestJS 使用模块组织应用程序结构，每个模块封装一组密切相关的功能，里面包含依赖的其他模块、路由控制器、事务处理方法等。每个应用程序至少有一个模块，即根模块。根模块是 Nest 用于构建应用程序图的起点。模块是由装饰器 @Module() 装饰的类。在项目中添加一个模块， 如 users： 1nest g mo users">
<meta property="og:type" content="article">
<meta property="og:title" content="NestJS 核心技术">
<meta property="og:url" content="http://example.com/2025/03/15/nest/nest%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/index.html">
<meta property="og:site_name" content="舞动的灵魂">
<meta property="og:description" content="Modules 模块NestJS 使用模块组织应用程序结构，每个模块封装一组密切相关的功能，里面包含依赖的其他模块、路由控制器、事务处理方法等。每个应用程序至少有一个模块，即根模块。根模块是 Nest 用于构建应用程序图的起点。模块是由装饰器 @Module() 装饰的类。在项目中添加一个模块， 如 users： 1nest g mo users">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-15T07:47:59.000Z">
<meta property="article:modified_time" content="2025-03-15T07:54:36.687Z">
<meta property="article:author" content="Silence">
<meta property="article:tag" content="node">
<meta property="article:tag" content="nest">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/03/15/nest/nest%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/03/15/nest/nest%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/","path":"2025/03/15/nest/nest核心功能/","title":"NestJS 核心技术"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>

<script>
    (function(){
        if(''){
            if (prompt('加密文，来试试你的运气吧！') !== ''){
                alert('要不要再尝试一次呢~~');
                history.back();
            }
        }
    })();
</script><title>NestJS 核心技术 | 舞动的灵魂</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">舞动的灵魂</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Modules-%E6%A8%A1%E5%9D%97"><span class="nav-text">Modules 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Controllers-%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-text">Controllers 控制器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="nav-text">获取请求参数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8E-url-%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0"><span class="nav-text">从 url 获取参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8E-body-%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0"><span class="nav-text">从 body 获取参数</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#application-json"><span class="nav-text">application&#x2F;json</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#multipart-form-data"><span class="nav-text">multipart&#x2F;form-data</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="nav-text">获取请求头</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94"><span class="nav-text">返回响应</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E6%96%87%E5%AD%97"><span class="nav-text">返回文字</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E6%96%87%E4%BB%B6"><span class="nav-text">返回文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81"><span class="nav-text">返回状态码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94%E5%A4%B4"><span class="nav-text">返回响应头</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94"><span class="nav-text">动态返回响应</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Providers-%E6%8F%90%E4%BE%9B%E8%80%85"><span class="nav-text">Providers 提供者</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Services-%E6%9C%8D%E5%8A%A1"><span class="nav-text">Services 服务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">使用方式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E6%B3%A8%E5%85%A5"><span class="nav-text">构造函数注入</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E6%B3%A8%E5%85%A5"><span class="nav-text">属性注入</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Provier"><span class="nav-text">自定义 Provier</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Class-providers%EF%BC%9AuseClass"><span class="nav-text">Class providers：useClass</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Non-class-based-providers%EF%BC%9AuseValue"><span class="nav-text">Non-class-based providers：useValue</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Factory-providers%EF%BC%9AuseFactory"><span class="nav-text">Factory providers：useFactory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%BC%E5%87%BA%E8%87%AA%E5%AE%9A%E4%B9%89-provider"><span class="nav-text">导出自定义 provider</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Middleware-%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">Middleware 中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">类中间件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">函数中间件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">应用中间件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E9%99%A4%E8%B7%AF%E7%94%B1"><span class="nav-text">排除路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%85%A8%E5%B1%80%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">设置全局中间件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipes-%E7%AE%A1%E9%81%93"><span class="nav-text">Pipes 管道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E7%AE%A1%E9%81%93"><span class="nav-text">内置管道</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ValidationPipe"><span class="nav-text">ValidationPipe</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E9%AA%8C%E8%AF%81"><span class="nav-text">自动验证</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%89%A5%E7%A6%BB%E5%B1%9E%E6%80%A7"><span class="nav-text">剥离属性</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%BD%AC%E6%8D%A2%E8%BD%BD%E8%8D%B7"><span class="nav-text">转换载荷</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ParseArrayPipe"><span class="nav-text">ParseArrayPipe</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E9%81%93"><span class="nav-text">自定义管道</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%A1%E9%81%93%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%8D%E7%BD%AE"><span class="nav-text">管道的使用位置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%8F%82%E6%95%B0%E7%AE%A1%E9%81%93"><span class="nav-text">1. 参数管道</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%E5%99%A8%E7%AE%A1%E9%81%93"><span class="nav-text">2. 路由处理器管道</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E6%8E%A7%E5%88%B6%E5%99%A8%E7%AE%A1%E9%81%93"><span class="nav-text">3. 控制器管道</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E5%85%A8%E5%B1%80%E7%AE%A1%E9%81%93"><span class="nav-text">4. 全局管道</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExecutionContext-%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-text">ExecutionContext 执行上下文</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ArgumentsHost"><span class="nav-text">ArgumentsHost</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Http-%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-text">Http 上下文</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Websocket-%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-text">Websocket 上下文</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ExecutionContext"><span class="nav-text">ExecutionContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-text">添加元数据</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Reflector"><span class="nav-text">Reflector</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetMetadata"><span class="nav-text">SetMetadata</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-text">获取元数据</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Reflector-1"><span class="nav-text">Reflector</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SetMetadata-1"><span class="nav-text">SetMetadata</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Guards-%E5%AE%88%E5%8D%AB"><span class="nav-text">Guards 守卫</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-text">定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-text">应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E7%BA%A7%E5%88%AB"><span class="nav-text">方法级别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B1%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">类级别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%A8%E5%B1%80"><span class="nav-text">全局</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interceptors-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-text">Interceptors 拦截器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-1"><span class="nav-text">定义</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#tap-%E6%93%8D%E4%BD%9C%E7%AC%A6%EF%BC%9A%E6%89%93%E5%8D%B0%E6%97%A5%E5%BF%97"><span class="nav-text">tap 操作符：打印日志</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#map-%E6%93%8D%E4%BD%9C%E7%AC%A6%EF%BC%9A%E4%BF%AE%E6%94%B9%E5%93%8D%E5%BA%94%E6%95%B0%E6%8D%AE"><span class="nav-text">map 操作符：修改响应数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#catchError-%E6%93%8D%E4%BD%9C%E7%AC%A6%EF%BC%9A%E8%A6%86%E7%9B%96%E5%BC%82%E5%B8%B8"><span class="nav-text">catchError 操作符：覆盖异常</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%93%8D%E4%BD%9C%E7%AC%A6%EF%BC%9A%E8%A6%86%E7%9B%96%E6%B5%81"><span class="nav-text">创建操作符：覆盖流</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-text">路由处理程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-text">控制器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%A8%E5%B1%80-1"><span class="nav-text">全局</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Silence"
      src="/images/touxiang.jpg">
  <p class="site-author-name" itemprop="name">Silence</p>
  <div class="site-description" itemprop="description">万花丛中过，片叶不沾身</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">126</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:silence@gmail.com" title="E-Mail → mailto:silence@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://jcoffeezph.top/" title="https:&#x2F;&#x2F;jcoffeezph.top&#x2F;" rel="noopener" target="_blank">ForMe</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://qzmvc1.top/" title="https:&#x2F;&#x2F;qzmvc1.top&#x2F;" rel="noopener" target="_blank">QzmVc1</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/15/nest/nest%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpg">
      <meta itemprop="name" content="Silence">
      <meta itemprop="description" content="万花丛中过，片叶不沾身">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舞动的灵魂">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          NestJS 核心技术
        </h1>

        <div class="post-meta-container">

          <div class="post-meta">
  
	
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-03-15 15:47:59 / 修改时间：15:54:36" itemprop="dateCreated datePublished" datetime="2025-03-15T15:47:59+08:00">2025-03-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Nest/" itemprop="url" rel="index"><span itemprop="name">Nest</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="Modules-模块"><a href="#Modules-模块" class="headerlink" title="Modules 模块"></a>Modules 模块</h3><p>NestJS 使用模块组织应用程序结构，每个模块封装一组密切相关的功能，里面包含依赖的其他模块、路由控制器、事务处理方法等。<br>每个应用程序至少有一个模块，即根模块。根模块是 Nest 用于构建应用程序图的起点。<br>模块是由装饰器 <code>@Module()</code> 装饰的类。<br>在项目中添加一个模块， 如 users：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g mo users</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>该命令会在 src 文件夹下创建 users 文件夹，其中包含 users.module.ts 文件。<br>module 文件应该像下面这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">    <span class="attr">imports</span>: [],</span><br><span class="line">    <span class="attr">controllers</span>: [],</span><br><span class="line">    <span class="attr">providers</span>: [],</span><br><span class="line">    <span class="attr">exports</span>: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Moudle</code> 的元数据有四个字段，它们起着非常重要的作用：</p>
<ol>
<li>imports：用来向当前模块导入其他模块。导入其它模块后，其他模块的控制器上下文就被包含在当前模块中，但 Provider 不能被当前模块直接使用，除非在被导入模块中，Provider 被包含在 exports 字段中，否则需要单独导入 Provider 并将其包含在当前模块的 providers 字段中。</li>
<li>controllers：引用控制器，使控制器作用于当前模块。</li>
<li>providers：将包含在其中的 Provider 注入到控制器中，以便控制器能直接使用它们。</li>
<li>exports：导出 Provider，使导入该模块的模块可直接使用包含在其中的 Provider。<h3 id="Controllers-控制器"><a href="#Controllers-控制器" class="headerlink" title="Controllers 控制器"></a>Controllers 控制器</h3>控制器负责注册路由，处理传入的请求并将响应返回给客户端。<br>控制器是由装饰器 <code>@Controller()</code> 装饰的类。<br>在项目中添加一个控制器，如 users：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g co users</span><br></pre></td></tr></table></figure>
该命令会在 users 文件夹中创建 users.controller.ts 文件。<br>controller 文件应该像下面这样：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Get, Post, Query &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserDto &#125; <span class="keyword">from</span> <span class="string">&quot;./user.dto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;list&quot;</span>) <span class="comment">// path = /users/list</span></span><br><span class="line">    <span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;分页&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">&quot;add&quot;</span>) <span class="comment">// path = /users/add</span></span><br><span class="line">    <span class="function"><span class="title">addUser</span>(<span class="params"><span class="meta">@Body</span>() user: UserDto</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;添加用户&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>@Controller</code> 注册模块的根路由，<code>@Get</code>，<code>@Post</code> 等方法注册子路由。<h4 id="获取请求参数"><a href="#获取请求参数" class="headerlink" title="获取请求参数"></a>获取请求参数</h4><h5 id="从-url-获取参数"><a href="#从-url-获取参数" class="headerlink" title="从 url 获取参数"></a>从 url 获取参数</h5>Get 方法的参数拼在路径后面，用 <code>&amp;</code> 分隔，如 <code>/users/list?page=1&amp;limit=10</code>，获取这种参数可使用 <code>@Query</code> 装饰器：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">    <span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(page, limit); <span class="comment">// &quot;1&quot; &quot;10&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
由于网络传输的都是字符串。因此这里获取到的 page 和 limit 都是 string 类型，想要将其转换成 number 类型，可直接使用管道 <code>ParseIntPip</code>。<br>修改代码：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ParseIntPipe, UsePipes, Get, Query &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">    <span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>, ParseIntPipe) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>, ParseIntPipe) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(page, limit); <span class="comment">// 1 10</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 或者</span></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">    <span class="meta">@UsePipes</span>(ParseIntPipe)</span><br><span class="line">    <span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(page, limit); <span class="comment">// 1 10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="从-body-获取参数"><a href="#从-body-获取参数" class="headerlink" title="从 body 获取参数"></a>从 body 获取参数</h5>通过 <code>@Body</code> 装饰器来获取 body 中的参数。<h6 id="application-json"><a href="#application-json" class="headerlink" title="application/json"></a>application/json</h6>application/json 是传输文本最常用的方式，代码入下：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Post &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserDto &#125; <span class="keyword">from</span> <span class="string">&quot;./user.dto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">&quot;add&quot;</span>)</span><br><span class="line">    <span class="function"><span class="title">addUser</span>(<span class="params"><span class="meta">@Body</span>() user: UserDto</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(user); <span class="comment">// &#123; name: &quot;xxx&quot;, age: &quot;20&quot;, sex: &quot;male&quot; &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>UserDto</code> 是一个数据传输对象（DTO，data transfer object），它是一个类，代码如下：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    age: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">    sex: <span class="string">&quot;male&quot;</span> | <span class="string">&quot;female&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
其实，用接口声明类型也是可以的，但如果要用管道（Pipes）的话，就必须使用类，因为管道会在运行时访问变量的元类型，而接口在编译过程中就被删除了。<br>开启 ValidationPipe 的 tranform 功能后，user 会自动被转换为 UserDto 对象：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Post, UsePipes, ValidationPipe &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UserDto &#125; <span class="keyword">from</span> <span class="string">&quot;./user.dto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">&quot;add&quot;</span>)</span><br><span class="line">    <span class="meta">@UsePipes</span>(<span class="keyword">new</span> ValidationPipe(&#123; <span class="attr">transform</span>: <span class="literal">true</span> &#125;))</span><br><span class="line">    <span class="function"><span class="title">addUser</span>(<span class="params"><span class="meta">@Body</span>() user: UserDto</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(user); <span class="comment">// UserDto &#123; name: &quot;xxx&quot;, age: &quot;20&quot;, sex: &quot;male&quot; &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="multipart-form-data"><a href="#multipart-form-data" class="headerlink" title="multipart/form-data"></a>multipart/form-data</h6>multipart/form-data 类型常用来上传文件。假如现在前端要上传这样一个 FormData：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">formData.append(<span class="string">&quot;file&quot;</span>, <span class="keyword">new</span> Blob([<span class="string">&quot;123456&quot;</span>]), <span class="string">&quot;xxx.txt&quot;</span>);</span><br><span class="line">formData.append(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Silence&quot;</span>);</span><br></pre></td></tr></table></figure>
后端该如何接收呢？<br>为了处理文件上传，Nest 提供了一个基于 Express 的 multer 中间件包的内置模块。Multer 处理以 multipart/form-data 格式上传的数据。<br>为了更好的类型提示，安装 Multer typings 包：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D @types/multer</span><br></pre></td></tr></table></figure>
此外，还需要用到 <code>FileInterceptor</code> 拦截器，将在下面介绍。<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Post, UploadedFile, UseInterceptors &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Express &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UploadDto &#125; <span class="keyword">from</span> <span class="string">&quot;./user.dto&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FileInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/platform-express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">&quot;upload&quot;</span>)</span><br><span class="line">    <span class="meta">@UseInterceptors</span>(FileInterceptor(<span class="string">&quot;file&quot;</span>))</span><br><span class="line">    <span class="function"><span class="title">upload</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Body</span>() upload: UploadDto,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@UploadedFile</span>()</span></span></span><br><span class="line"><span class="params"><span class="function">        file: Express.Multer.File</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(upload, file.buffer.toString());</span><br><span class="line">        <span class="comment">// &#123; name: &quot;Silence&quot; &#125; 123456</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
通过 <code>@UseInterceptors()</code> 装饰器使用拦截器，<code>FileInterceptor()</code> 拦截器第一个参数是 FormData 中文件对应的 key，通过 <code>@UploadedFile()</code> 装饰器将文件信息注入到 file 参数中。<br>FormData 中除文件之外的字段以及值会被 <code>@Body()</code> 注入到 upload 参数中。<br><code>Express.Multer.File</code> 对象有以下几个属性：</li>
</ol>
<ul>
<li>buffer：Buffer 类型，通过 buffer.toString() 可获取到文件的文本内容</li>
<li>originalname：文件名</li>
<li>mimetype：文件的类型</li>
<li>size：文件大小</li>
</ul>
<p>我们还可以通过管道对文件进行验证，比如验证文件大小，文件类型等等，未通过验证的话直接向客户端返回响应。<br>Nest 提供了一个内置的管道来处理常见的异常：<code>ParseFilePipe</code>，使用方式如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Body, Controller, Post, UploadedFile, UseInterceptors, ParseFilePipe,</span><br><span class="line">    BadRequestException, MaxFileSizeValidator, FileTypeValidator &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Express &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UploadDto &#125; <span class="keyword">from</span> <span class="string">&quot;./user.dto&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FileInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/platform-express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Post</span>(<span class="string">&quot;upload&quot;</span>)</span><br><span class="line">    <span class="meta">@UseInterceptors</span>(FileInterceptor(<span class="string">&quot;file&quot;</span>))</span><br><span class="line">    upload(</span><br><span class="line">        <span class="meta">@Body</span>() upload: UploadDto,</span><br><span class="line">        <span class="meta">@UploadedFile</span>(<span class="keyword">new</span> ParseFilePipe(&#123;</span><br><span class="line">            <span class="attr">fileIsRequired</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">validators</span>: [</span><br><span class="line">                <span class="keyword">new</span> FileTypeValidator(&#123; <span class="attr">fileType</span>: <span class="string">&quot;image/png&quot;</span> &#125;),</span><br><span class="line">                <span class="keyword">new</span> MaxFileSizeValidator(&#123; <span class="attr">maxSize</span>: <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span> &#125;)</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">errorHttpStatusCode</span>: <span class="number">400</span>,</span><br><span class="line">            <span class="attr">exceptionFactory</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(error);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException(error);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;))</span><br><span class="line">        <span class="attr">file</span>: Express.Multer.File</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(upload, file.buffer.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ParseFilePipe 构造函数的参数包含四个字段：</p>
<ul>
<li><code>fileIsRequired</code>：FormData 中是否必须包含文件，默认为 true，若不包含文件自动响应 400 错误</li>
<li><code>validators</code>：验证器数组，Nest 内置了 FileTypeValidator 和 MaxFileSizeValidator 两个验证器<ul>
<li>FileTypeValidator：验证文件类型，其原理是根据文件后缀名进行验证</li>
<li>MaxFileSizeValidator：验证文件的大小是否小于给定值（单位字节）</li>
</ul>
</li>
<li><code>errorHttpStatusCode</code>：验证失败返回响应的状态码，默认 400</li>
<li><code>exceptionFactory</code>：异常工厂函数，用来自定义返回异常的内容并记录日志，有了这个就不用再定义 errorHttpStatusCode</li>
</ul>
<p>如果想进行更多的验证，可以自定义验证器，并将其加入到 validators 数组中。<br>更多关于文件上穿的内容请见 <a target="_blank" rel="noopener" href="https://docs.nestjs.com/techniques/file-upload">https://docs.nestjs.com/techniques/file-upload</a>。</p>
<h5 id="获取请求头"><a href="#获取请求头" class="headerlink" title="获取请求头"></a>获取请求头</h5><p>通过 <code>@Headers()</code> 装饰器可以将请求头中的内容注入到参数中：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Get, Query, Headers &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    <span class="function"><span class="title">getUserName</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;id&quot;</span>) id: <span class="built_in">string</span>, <span class="meta">@Headers</span>(<span class="string">&quot;Content-Type&quot;</span>) <span class="keyword">type</span>: <span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">type</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="返回响应"><a href="#返回响应" class="headerlink" title="返回响应"></a>返回响应</h4><h5 id="返回文字"><a href="#返回文字" class="headerlink" title="返回文字"></a>返回文字</h5><p>返回文字内容只需在路由函数中 <code>return</code> 你想返回的内筒即可。由于 Nest 框架会自动将返回结果序列化，因此我们不需要考虑格式问题。</p>
<h5 id="返回文件"><a href="#返回文件" class="headerlink" title="返回文件"></a>返回文件</h5><p>从服务端向客户端发送文件，可以使用 <code>StreamableFile</code> 类，示例如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, StreamableFile &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createReadStream &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FileController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  getFile(): StreamableFile &#123;</span><br><span class="line">    <span class="keyword">const</span> file = createReadStream(join(process.cwd(), <span class="string">&#x27;package.json&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StreamableFile(file);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认的内容类型（Content-Type）是 application/octet-stream，且没有文件名，如果你需要自定义这个值，你可以使用 StreamableFile 中的 type 选项:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, StreamableFile &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createReadStream &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FileController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  getFile(): StreamableFile &#123;</span><br><span class="line">    <span class="keyword">const</span> file = createReadStream(join(process.cwd(), <span class="string">&#x27;package.json&#x27;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StreamableFile(file, &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">      <span class="attr">disposition</span>: <span class="string">&#x27;attachment; filename=&quot;package.json&quot;&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="返回状态码"><a href="#返回状态码" class="headerlink" title="返回状态码"></a>返回状态码</h5><p>响应状态代码默认为 200，而 POST 请求是 201。我们可以通过 <code>@HttpCode()</code> 装饰器改变响应状态码。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@HttpCode</span>(<span class="number">204</span>)</span><br><span class="line"><span class="function"><span class="title">add</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;This action adds a new user&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="返回响应头"><a href="#返回响应头" class="headerlink" title="返回响应头"></a>返回响应头</h5><p>要自定义响应头，可以使用 <code>@Header()</code> 装饰器。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@Header</span>(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;none&quot;</span>)</span><br><span class="line"><span class="function"><span class="title">add</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;This action adds a new user&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="动态返回响应"><a href="#动态返回响应" class="headerlink" title="动态返回响应"></a>动态返回响应</h5><p>使用装饰器返回状态码和响应头是静态的，但是大多数情况都是需要根据业务逻辑动态决定返回什么，因此，我们需要有其他操作响应的方式。<br>Nest 框架允许我们通过 <code>@Res()</code> 装饰器将其底层 http 框架（express）的 response 注入到参数中供我们使用。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Post, Res, HttpStatus &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Response &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="function"><span class="title">add</span>(<span class="params"><span class="meta">@Res</span>() res: Response</span>)</span> &#123;</span><br><span class="line">    res.status(HttpStatus.OK).json([]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，这种方法会脱离框架提供的响应处理，如 <code>@HttpCode()</code>，<code>@Header()</code> 将不再起作用，不能直接通过 return 返回响应等等。此外，代码变得依赖于底层平台（express，fastify）。<br>要解决这个问题，可以将 <code>passthrough</code> 选项设置为 true，如下所示：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Post, Res, HttpStatus &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Response &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="function"><span class="title">add</span>(<span class="params"><span class="meta">@Res</span>(&#123; passthrough: <span class="literal">true</span> &#125;) res: Response</span>)</span> &#123;</span><br><span class="line">    res.status(HttpStatus.OK);</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Providers-提供者"><a href="#Providers-提供者" class="headerlink" title="Providers 提供者"></a>Providers 提供者</h3><p>providers 主要用来提供一些辅助性的功能。许多基本的 Nest 类都可以被视为 providers，如 services、repositories、factories、helpers 等等。<br>实际上，providers 不一定是类，还可以是对象、字符串、数字等类型。<br>providers 被设计由 controllers 使用。</p>
<blockquote>
<p>注意：<code>@Injectable()</code> 装饰器与 Providers 之间没有必然联系。<code>@Injectable()</code> 意思是可以注入的，指的是可以在被装饰类中注入其他依赖，若不需要注入依赖则不用装饰，而不是只有被装饰的类才可以作为 Provider。</p>
</blockquote>
<h4 id="Services-服务"><a href="#Services-服务" class="headerlink" title="Services 服务"></a>Services 服务</h4><p>一般来说，controller 只负责接收请求、处理请求参数、返回响应内容，那么具体的业务逻辑就交给 services 去处理。<br>在项目中添加一个服务，如 users：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g s users</span><br></pre></td></tr></table></figure>
<p>该命令会在 users 文件夹中创建 users.service.ts 文件。<br>它看起来像下面这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&quot;./user.interface&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersService</span> </span>&#123;</span><br><span class="line">    getUserList(page: <span class="built_in">number</span>, <span class="attr">limit</span>: <span class="built_in">number</span>): <span class="built_in">Array</span>&lt;User&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;silence&quot;</span>,</span><br><span class="line">                <span class="attr">age</span>: page + limit,</span><br><span class="line">                <span class="attr">sex</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如需注入其他依赖，应写成这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, Inject &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; User &#125; <span class="keyword">from</span> <span class="string">&quot;./user.interface&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="meta">@Inject</span>(<span class="string">&quot;token&quot;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> token: <span class="built_in">string</span></span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  getUserList(page: <span class="built_in">number</span>, <span class="attr">limit</span>: <span class="built_in">number</span>): <span class="built_in">Array</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;silence&quot;</span>,</span><br><span class="line">        <span class="attr">age</span>: page + limit,</span><br><span class="line">        <span class="attr">sex</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h5><p>services 使用方式有以下两种。</p>
<h6 id="构造函数注入"><a href="#构造函数注入" class="headerlink" title="构造函数注入"></a>构造函数注入</h6><p>在 controller 中这样使用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Query &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UsersService &#125; <span class="keyword">from</span> <span class="string">&quot;./users.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> usersService: UsersService</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">    <span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.usersService.getUserList(page, limit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里只是将 service 对象作为 controller 的构造函数的参数，就可以直接在路由方法中使用，这是因为 service 的实例化由框架自动完成。<br>这种将 service 实例注入到构造函数参数中的方式称为构造函数注入。</p>
<h6 id="属性注入"><a href="#属性注入" class="headerlink" title="属性注入"></a>属性注入</h6><p>上面的代码也可以替换成这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Query, Inject &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; UsersService &#125; <span class="keyword">from</span> <span class="string">&quot;./users.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span>()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> usersService: UsersService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">    <span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.usersService.getUserList(page, limit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Inject()</code> 装饰器会将 service 的实例注入到声明为 service 对象的 controller 的属性中，这种方式称为属性注入。<br>为什么需要属性注入呢？它与构造函数注入有什么不同？<br>想象一下，你定义了一个 service，它依赖了其他的 provider，像下面这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">protected</span> <span class="keyword">readonly</span> firstProvider: FirstProvider,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">protected</span> <span class="keyword">readonly</span> secondProvider: SecondProvider,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">protected</span> <span class="keyword">readonly</span> thirdProvider: ThirdProvider</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，你想要实现一个子类继承 MyService，那么，你需要在子类的 <code>super()</code> 方法中传递所有参数：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MySubService</span> <span class="keyword">extends</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">          <span class="keyword">private</span> <span class="keyword">readonly</span> firstProvider: FirstProvider,</span></span><br><span class="line"><span class="params">          <span class="keyword">private</span> <span class="keyword">readonly</span> secondProvider: SecondProvider,</span></span><br><span class="line"><span class="params">          <span class="keyword">private</span> <span class="keyword">readonly</span> thirdProvider: ThirdProvider</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="built_in">super</span>(firstProvider, secondProvider, thirdProvider);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话，MyService 的子类，子类的子类…都需要传递大量参数，非常不便。为避免这种情况，可以使用属性注入的方法，子类不需要 <code>super()</code> 父类中的 Provider 实例。</p>
<blockquote>
<p>注意：如果一个 Service 没有被继承，那么建议使用构造函数注入。构造函数显式地概述了需要哪些依赖项，并提供比属性注入更好的可见性。</p>
</blockquote>
<h4 id="自定义-Provier"><a href="#自定义-Provier" class="headerlink" title="自定义 Provier"></a>自定义 Provier</h4><p>在 Modules 中，我们这样注册 providers：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UsersService &#125; <span class="keyword">from</span> <span class="string">&quot;./users.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [UsersService]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它其实是下面这种写法的缩写：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UsersService &#125; <span class="keyword">from</span> <span class="string">&quot;./users.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: UsersService,</span><br><span class="line">      <span class="attr">useClass</span>: UsersService</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>provide</code> 字段是 provider 的 token，用于请求同名类的实例，<code>useClass</code> 指定 provider 提供的类。</p>
<h5 id="Class-providers：useClass"><a href="#Class-providers：useClass" class="headerlink" title="Class providers：useClass"></a>Class providers：useClass</h5><p>对于 Class 类型的 providers，一般使用简写即可，但有些场景需要我们动态选择 providers 的类，就需要用到 <code>useClass</code>。<br><code>useClass</code> 语法允许我们动态确定令牌应解析到的类。例如，我们有一个抽象类 <code>ConfigService</code>，我们希望 Nest 可以根据当前环境提供不同的配置服务。下面的代码实现了这样的策略。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: ConfigService,</span><br><span class="line">      <span class="attr">useClass</span>:</span><br><span class="line">        process.env.NODE_ENV === <span class="string">&#x27;development&#x27;</span></span><br><span class="line">          ? DevelopmentConfigService</span><br><span class="line">          : ProductionConfigService,</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>由于 <code>DevelopmentConfigService</code> 类和 <code>ProductionConfigService</code> 类都继承自 <code>ConfigService</code>，因此，在 provider 注入时类型写 <code>ConfigService</code> 即可。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> configService: ConfigService</span>);</span><br></pre></td></tr></table></figure>
<p>若想要自定义令牌，如：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UsersService &#125; <span class="keyword">from</span> <span class="string">&quot;./users.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;users-service&quot;</span>,</span><br><span class="line">      <span class="attr">useClass</span>: UsersService</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么在 controller 文件中就要这样注入依赖：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="meta">@Inject</span>(<span class="string">&quot;users-service&quot;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> usersService: UsersService</span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Non-class-based-providers：useValue"><a href="#Non-class-based-providers：useValue" class="headerlink" title="Non-class-based providers：useValue"></a>Non-class-based providers：useValue</h5><p>虽然 providers 经常提供服务，但他们并不限于这种用途，providers 可以提供任何值。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;person&quot;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;Silence&quot;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; </span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;log&quot;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;log provider&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: <span class="string">&quot;Silence&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>在 controller 文件中注入：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Inject</span>(<span class="string">&quot;person&quot;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> person: &#123; name: <span class="built_in">string</span>; age: <span class="built_in">number</span> &#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Inject</span>(<span class="string">&quot;log&quot;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> log: () =&gt; <span class="built_in">void</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Inject</span>(<span class="string">&quot;name&quot;</span>) <span class="keyword">private</span> <span class="keyword">readonly</span> name: <span class="built_in">string</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Factory-providers：useFactory"><a href="#Factory-providers：useFactory" class="headerlink" title="Factory providers：useFactory"></a>Factory providers：useFactory</h5><p><code>useFactory</code> 允许动态创建 providers，它的返回值就是 provider 要提供的值。支持异步。<br><code>inject</code> 字段是一个 providers 数组，数组中的 providers 会按顺序被注入到 <code>userFactory</code> 的参数中供其使用。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;person&quot;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;Silence&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;log&quot;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: <span class="function">(<span class="params">msg: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;log-person&quot;</span>,</span><br><span class="line">      <span class="attr">useFactory</span>: <span class="function">(<span class="params">log: (msg: <span class="built_in">string</span>) =&gt; <span class="built_in">void</span>, person?: &#123; name: <span class="built_in">string</span>; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            log(person?.name);</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">inject</span>: [<span class="string">&quot;log&quot;</span>, &#123; <span class="attr">token</span>: <span class="string">&quot;person&quot;</span>, <span class="attr">optional</span>: <span class="literal">true</span> &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="导出自定义-provider"><a href="#导出自定义-provider" class="headerlink" title="导出自定义 provider"></a>导出自定义 provider</h5><p>可以直接导出 token，也可以导出整个 provider。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logProvider = &#123;</span><br><span class="line">  <span class="attr">provide</span>: <span class="string">&quot;log&quot;</span>,</span><br><span class="line">  <span class="attr">useValue</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;log provider&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;person&quot;</span>,</span><br><span class="line">      <span class="attr">useValue</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;Silence&quot;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    logProvider</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="string">&quot;person&quot;</span>, logProvider]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Middleware-中间件"><a href="#Middleware-中间件" class="headerlink" title="Middleware 中间件"></a>Middleware 中间件</h3><p>中间件是在路由处理器之前调用的函数。<br>中间件函数可以访问 request 和 response 对象，以及 <code>next()</code> 方法(下一个中间件函数)。<br>中间件有以下几个功能：</p>
<blockquote>
<ol>
<li>对 request 和 response 对象进行更改</li>
<li>结束请求-响应周期（直接返回响应）</li>
<li>调用下一个中间件函数</li>
<li>如果当前的中间件函数没有结束请求-响应周期, 它必须调用 next() 将控制传递给下一个中间件函数。否则，请求将被挂起。</li>
</ol>
</blockquote>
<p>我们可以在函数或带有 <code>@Injectable()</code> 装饰器的类中自定义中间件。</p>
<h4 id="类中间件"><a href="#类中间件" class="headerlink" title="类中间件"></a>类中间件</h4><p>使用类的话，需要实现 <code>NestMiddleware</code> 接口。<br>生成一个中间件文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g mi auth middlewares --flat</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, NestMiddleware &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response, NextFunction &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthMiddleware</span> <span class="title">implements</span> <span class="title">NestMiddleware</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">use</span>(<span class="params">req: Request, res: Response, next: NextFunction</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (req.headers.Authorization) &#123;</span><br><span class="line">        next();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.status(<span class="number">403</span>).send(<span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数中间件"><a href="#函数中间件" class="headerlink" title="函数中间件"></a>函数中间件</h4><p>如果我们想定义一个中间件，它没有成员，没有额外的方法，也没有依赖项，那么完全可以使用一个简单的函数而不是类。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Request, Response, NextFunction &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params">req: Request, res: Response, next: NextFunction</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;请求路径：&quot;</span>, req.baseUrl);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;请求方法：&quot;</span>, req.method);</span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="应用中间件"><a href="#应用中间件" class="headerlink" title="应用中间件"></a>应用中间件</h4><p>我们需要在 Module 层面应用中间件，Module 类须实现 <code>NestModule</code> 接口的 <code>configure()</code> 方法。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; MiddlewareConsumer, Module, NestModule &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersController &#125; <span class="keyword">from</span> <span class="string">&quot;./users.controller&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; logger &#125; <span class="keyword">from</span> <span class="string">&quot;../middlewares/logger.middleware&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthMiddleware &#125; <span class="keyword">from</span> <span class="string">&quot;../middlewares/auth.middleware&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [],</span><br><span class="line">  <span class="attr">controllers</span>: [UsersController],</span><br><span class="line">  <span class="attr">providers</span>: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>)</span> &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .apply(logger, AuthMiddleware)</span><br><span class="line">      .forRoutes(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>apply()</code> 方法用于注册中间件，其参数的顺序决定了中间件的调用顺序。<br><code>forRoutes()</code> 方法用于限制中间件只能作用于符合规定路由的请求。其参数可以是字符出串（路由通配符），RouteInfo 对象，和 Controller。</p>
<blockquote>
<p>注意：</p>
<ol>
<li><code>configure()</code> 方法支持 async/await。</li>
<li>中间件的作用范围和它是在哪个模块中被注册的无关，而是取决于路由规则。</li>
</ol>
</blockquote>
<p>MiddlewareConsumer 支持链式调用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; RequestMethod &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [],</span><br><span class="line">  <span class="attr">controllers</span>: [UsersController],</span><br><span class="line">  <span class="attr">providers</span>: []</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersModule</span> <span class="title">implements</span> <span class="title">NestModule</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">configure</span>(<span class="params">consumer: MiddlewareConsumer</span>)</span> &#123;</span><br><span class="line">    consumer</span><br><span class="line">      .apply(logger)</span><br><span class="line">      .forRoutes(UsersController)</span><br><span class="line">      .apply(AuthMiddleware)</span><br><span class="line">      .forRoutes(&#123; <span class="attr">path</span>: <span class="string">&quot;*&quot;</span>, <span class="attr">method</span>: RequestMethod.ALL &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="排除路由"><a href="#排除路由" class="headerlink" title="排除路由"></a>排除路由</h4><p>有时候我们想排除某些路由，不应用中间件。可以用 <code>exclusive()</code> 方法。此方法可以采用单个字符串、多个字符串或 RouteInfo 对象来标识要排除的路由，如下所示：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">consumer</span><br><span class="line">  .apply(LoggerMiddleware)</span><br><span class="line">  .exclude(</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">&#x27;cats&#x27;</span>, <span class="attr">method</span>: RequestMethod.GET &#125;,</span><br><span class="line">    &#123; <span class="attr">path</span>: <span class="string">&#x27;cats&#x27;</span>, <span class="attr">method</span>: RequestMethod.POST &#125;,</span><br><span class="line">    <span class="string">&#x27;cats/(.*)&#x27;</span>,</span><br><span class="line">  )</span><br><span class="line">  .forRoutes(CatsController);</span><br></pre></td></tr></table></figure>
<h4 id="设置全局中间件"><a href="#设置全局中间件" class="headerlink" title="设置全局中间件"></a>设置全局中间件</h4><p>可以使用 <code>app.use()</code> 方法来注册全局中间件：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">app.use(logger);</span><br><span class="line"><span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：此方法只能注册函数中间件和没有依赖注入的类中间件，对于有依赖注入的类中间件，需要在根模块（或<strong>任何其他模块</strong>）中用 <code>.forRoutes（&#39;*&#39;）</code>。</p>
</blockquote>
<h3 id="Pipes-管道"><a href="#Pipes-管道" class="headerlink" title="Pipes 管道"></a>Pipes 管道</h3><p>管道有两个典型的应用场景：</p>
<ol>
<li>转换：将输入数据转换为期望的格式，如将字符串转换为数字</li>
<li>验证：验证输入的数据，如果合格则通过，否则抛出异常</li>
</ol>
<p>管道对控制器路由的<strong>参数</strong>进行操作，Nest 在调用路由方法之前插入一个管道，管道接收指定给方法的参数并对它们进行操作。转换或验证操作都在此时发生，之后路由处理程序使用的是转换后的参数。<br>Nest 配备了许多内置管道，可以使用开箱即用。</p>
<h4 id="内置管道"><a href="#内置管道" class="headerlink" title="内置管道"></a>内置管道</h4><ul>
<li>ValidationPipe：验证参数类型，并将其转换为声明的类型</li>
<li>ParseIntPipe：验证参数类型，并将其转换为 Int 类型</li>
<li>ParseFloatPipe：验证参数类型，并将其转换为 Float 类型</li>
<li>ParseBoolPipe：验证参数类型，并将其转换为 Boolean 类型</li>
<li>ParseArrayPipe：按照规则验证参数并将其转换为数组</li>
<li>ParseUUIDPipe：验证参数否为 uuid</li>
<li>DefaultValuePipe：为参数添加默认值</li>
<li>ParseFilePipe：解析文件<h5 id="ValidationPipe"><a href="#ValidationPipe" class="headerlink" title="ValidationPipe"></a>ValidationPipe</h5>ValidationPipe 提供了一种方便的方法来为所有传入的有效载荷实施验证规则，其中特定的规则是通过装饰器装饰 DTO 类的属性来声明的。<br>在使用之前，需安装依赖：<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i class-validator class-transformer</span><br></pre></td></tr></table></figure>
下面介绍一些该管道常用的配置项：</li>
</ul>
<table>
<thead>
<tr>
<th>选项</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>transform</td>
<td>boolean</td>
<td>为 true 则将参数转换为声明的类型</td>
</tr>
<tr>
<td>disableErrorMessages</td>
<td>boolean</td>
<td>为 true 则不会将验证的错误返回给客户端</td>
</tr>
<tr>
<td>whitelist</td>
<td>boolean</td>
<td>为 true 则将从返回结果中剥离 DTO 中未用类验证装饰器装饰的属性</td>
</tr>
<tr>
<td>errorHttpStatusCode</td>
<td>number</td>
<td>指定返回错误的状态码，默认 400</td>
</tr>
<tr>
<td>exceptionFactory</td>
<td>Fuction</td>
<td>获取错误数组并自定义抛出异常</td>
</tr>
</tbody></table>
<h6 id="自动验证"><a href="#自动验证" class="headerlink" title="自动验证"></a>自动验证</h6><p>假如现在定义了这样一个路由处理器：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="function"><span class="title">addUser</span>(<span class="params"><span class="meta">@Body</span>() user: UserDto</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们希望能够验证 UserDto 属性的类型，此时就可以将 <code>ValidationPipe</code> 与 <code>class-validator</code> 结合起来。<br>先为 UserDto 的属性添加验证规则：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; IsString, IsNumber, IsEnum &#125; <span class="keyword">from</span> <span class="string">&quot;class-validator&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line">    <span class="meta">@IsString</span>()</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IsNumber</span>()</span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IsEnum</span>([<span class="string">&quot;male&quot;</span>, <span class="string">&quot;female&quot;</span>])</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;male&quot;</span> | <span class="string">&quot;female&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IsPhoneNumber</span>()</span><br><span class="line">    <span class="attr">phoneNumber</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在路由处理器中使用 <code>ValidationPipe</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@UsePipes</span>(ValidationPipe)</span><br><span class="line"><span class="function"><span class="title">addUser</span>(<span class="params"><span class="meta">@Body</span>() user: UserDto</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，请求中的载荷会被自动验证，验证失败则会向客户端返回 400 错误，错误信息是一个数组。<br>我们可以通过 <code>disableErrorMessages: true</code> 禁用详细错误信息，或使用 <code>exceptionFactory</code> 自定义错误信息。</p>
<h6 id="剥离属性"><a href="#剥离属性" class="headerlink" title="剥离属性"></a>剥离属性</h6><p><code>ValidationPipe</code> 还可以过滤掉不应该被方法处理器接收的属性。通过 <code>whitelist: true</code> 来启用这一特性，其原理是被验证装饰器装饰的属性会被加入白名单并保留，而那些没有被装饰的属性就会被过滤掉。<br>例如 DTO 文件是下面这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; IsString, IsNumber, IsEnum &#125; <span class="keyword">from</span> <span class="string">&quot;class-validator&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line">    <span class="meta">@IsString</span>()</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    </span><br><span class="line">    age: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么路由处理器接收到的参数不包含 <code>age</code> 属性。</p>
<h6 id="转换载荷"><a href="#转换载荷" class="headerlink" title="转换载荷"></a>转换载荷</h6><p>通过网络进入的有效负载是普通的 JavaScript 对象。<code>ValidationPipe</code> 可以自动将有效负载转换为其 DTO 类的对象。<br>要启用自动转换，请设置 <code>transform: true</code>。<br>启用后，它不仅可以将载荷转换为 DTO 对象，还可以将参数转换为其声明的类型，相当于 <code>ParseIntPipe</code>、<code>ParseBoolPipe</code>。</p>
<p><code>ValidationPipe</code> 一般在全局使用。</p>
<h5 id="ParseArrayPipe"><a href="#ParseArrayPipe" class="headerlink" title="ParseArrayPipe"></a>ParseArrayPipe</h5><p>TypeScript 不存储有关泛型或接口的元数据，因此，在 DTO 中使用它们时，<code>ValidationPipe</code> 可能无法正确验证传入的数据。<br>例如，在下面的代码中，将无法正确验证 users：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@UsePipes</span>(ValidationPipe)</span><br><span class="line"><span class="function"><span class="title">addUser</span>(<span class="params"><span class="meta">@Body</span>() users: <span class="built_in">Array</span>&lt;UserDto&gt;</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而且，users 也不会被转换为 UserDto 对象数组。<br>这时，就需要 <code>ParseArrayPipe</code> 去验证数组：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@UsePipes</span>(<span class="keyword">new</span> ParseArrayPipe(&#123; <span class="attr">items</span>: UserDto &#125;))</span><br><span class="line"><span class="function"><span class="title">addUser</span>(<span class="params"><span class="meta">@Body</span>() users: <span class="built_in">Array</span>&lt;UserDto&gt;</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时，数组的验证和转换都正常了。<br>此外，它还可以根据分隔符将参数转换为数组，例如参数是一个 id 字符串：”1,2,3”：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="function"><span class="title">findByIds</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="meta">@Query</span>(<span class="string">&#x27;ids&#x27;</span>, <span class="keyword">new</span> ParseArrayPipe(&#123; items: <span class="built_in">Number</span>, separator: <span class="string">&#x27;,&#x27;</span> &#125;))</span></span></span><br><span class="line"><span class="params"><span class="function">  ids: <span class="built_in">number</span>[]</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(ids); <span class="comment">// [1, 2, 3]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义管道"><a href="#自定义管道" class="headerlink" title="自定义管道"></a>自定义管道</h4><p>创建一个 pipe 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g pi custom pipes --flat</span><br></pre></td></tr></table></figure>
<p>我们需要实现 <code>PipeTransform</code> 的 <code>transform</code> 方法。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PipeTransform, Injectable, ArgumentMetadata &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">transform</span>(<span class="params">value: <span class="built_in">any</span>, metadata: ArgumentMetadata</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>transform</code> 方法有两个参数：</p>
<ul>
<li><code>value</code>：当前路由处理方法的参数（在路由处理方法接收到它之前）</li>
<li><code>metadata</code>：当前路由处理方法参数的元数据，有以下属性：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> ArgumentMetadata &#123;</span><br><span class="line">  <span class="comment">// 表示提取参数的装饰器类型</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;body&#x27;</span> | <span class="string">&#x27;query&#x27;</span> | <span class="string">&#x27;param&#x27;</span> | <span class="string">&#x27;custom&#x27;</span>;</span><br><span class="line">  <span class="comment">// 参数的元类型，例如 String，UserDto，或 undefined</span></span><br><span class="line">  metatype?: Type&lt;unknown&gt;;</span><br><span class="line">  <span class="comment">// 传递给参数装饰器的字符串，例如 @Body（&#x27;[data]&#x27;）。如果未传参，它是 undefined。</span></span><br><span class="line">  data?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
接下来我们实现一个自定义的 ParseIntPipe：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ArgumentMetadata, BadRequestException, Injectable, PipeTransform &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">transform</span>(<span class="params">value: <span class="built_in">any</span>, metadata: ArgumentMetadata</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; metatype, <span class="keyword">type</span> &#125; = metadata;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">type</span> === <span class="string">&quot;query&quot;</span> || <span class="keyword">type</span> === <span class="string">&quot;param&quot;</span>) &amp;&amp; metatype.name === <span class="string">&quot;Number&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">new</span> metatype(value);</span><br><span class="line">      <span class="keyword">if</span> (res.toString() === <span class="string">&quot;NaN&quot;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> BadRequestException();</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="管道的使用位置"><a href="#管道的使用位置" class="headerlink" title="管道的使用位置"></a>管道的使用位置</h4>管道的使用位置有四种。<h5 id="1-参数管道"><a href="#1-参数管道" class="headerlink" title="1. 参数管道"></a>1. 参数管道</h5>管道可以作为 <code>@Query()</code>、<code>@Body()</code>、<code>@Param()</code> 等装饰器的参数，只作用于当前路由的特定参数。<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>, ParseIntPipe) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(page, limit)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-路由处理器管道"><a href="#2-路由处理器管道" class="headerlink" title="2. 路由处理器管道"></a>2. 路由处理器管道</h5>通过 <code>@UsePipes()</code> 装饰路由处理器，并将管道传入 <code>@UsePipes()</code> 中，此时管道作用于当前路由处理器的所有参数。<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="meta">@UsePipes</span>(ParseIntPipe)</span><br><span class="line"><span class="function"><span class="title">getList</span>(<span class="params"><span class="meta">@Query</span>(<span class="string">&quot;page&quot;</span>) page: <span class="built_in">number</span>, <span class="meta">@Query</span>(<span class="string">&quot;limit&quot;</span>) limit: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(page, limit)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-控制器管道"><a href="#3-控制器管道" class="headerlink" title="3. 控制器管道"></a>3. 控制器管道</h5>与路由处理器管道类似，只不过 <code>@UsePipes()</code> 装饰的是控制器，此时管道作用于当前控制器的所有路由处理器的参数。<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;users&quot;</span>)</span><br><span class="line"><span class="meta">@UsePipes</span>(ParseIntPipe)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-全局管道"><a href="#4-全局管道" class="headerlink" title="4. 全局管道"></a>4. 全局管道</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line"></span><br><span class="line">app.useGlobalPipes(<span class="keyword">new</span> ValidationPipe(&#123; <span class="attr">transform</span>: <span class="literal">true</span>, <span class="attr">disableErrorMessages</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
这种方式无法进行依赖注入。解决方法：可以作为 provider 在任意模块中设置以供全局使用：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;validation-pipe&quot;</span>,</span><br><span class="line">      <span class="attr">useClass</span>: ValidationPipe</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
全局管道作用于所有请求的参数。<h3 id="ExecutionContext-执行上下文"><a href="#ExecutionContext-执行上下文" class="headerlink" title="ExecutionContext 执行上下文"></a>ExecutionContext 执行上下文</h3><h4 id="ArgumentsHost"><a href="#ArgumentsHost" class="headerlink" title="ArgumentsHost"></a>ArgumentsHost</h4><code>ArgumentsHost</code> 类提供用于检索传递给处理程序的参数的方法。<br>它允许选择适当的上下文（HTTP、RPC、微服务或 WebSockets）来检索参数。<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Switch context to RPC.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">switchToRpc(): RpcArgumentsHost;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Switch context to HTTP.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">switchToHttp(): HttpArgumentsHost;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Switch context to WebSockets.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">switchToWs(): WsArgumentsHost;</span><br></pre></td></tr></table></figure>
<h5 id="Http-上下文"><a href="#Http-上下文" class="headerlink" title="Http 上下文"></a>Http 上下文</h5><code>switchToHttp()</code> 方法返回一个适用于 Http 上下文的 <code>HttpArgumentsHost</code> 对象，他有两个有用的方法：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ctx = host.switchToHttp();</span><br><span class="line"><span class="keyword">const</span> request = ctx.getRequest&lt;Request&gt;();</span><br><span class="line"><span class="keyword">const</span> response = ctx.getResponse&lt;Response&gt;();</span><br></pre></td></tr></table></figure>
分别可以获取到 request 对象和 response 对象。<h5 id="Websocket-上下文"><a href="#Websocket-上下文" class="headerlink" title="Websocket 上下文"></a>Websocket 上下文</h5><code>switchToWs()</code> 方法返回一个适用于 Websocket 上下文的 <code>WsArgumentsHost</code> 对象，他有两个有用的方法：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> WsArgumentsHost &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the data object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getData&lt;T&gt;(): T;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the client object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getClient&lt;T&gt;(): T;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
分别可以获取到传输数据和客户端连接。<h4 id="ExecutionContext"><a href="#ExecutionContext" class="headerlink" title="ExecutionContext"></a>ExecutionContext</h4>ExecutionContext 继承了 ArgumentsHost，提供了关于当前执行进程的其他信息。<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> ExecutionContext <span class="keyword">extends</span> ArgumentsHost &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the type of the controller class which the current handler belongs to.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getClass&lt;T&gt;(): Type&lt;T&gt;;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns a reference to the handler (method) that will be invoked next in the</span></span><br><span class="line"><span class="comment">   * request pipeline.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getHandler(): <span class="built_in">Function</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>getHandler()</code> 方法返回一个将要被调用的路由处理程序的引用。<br><code>getClass()</code> 方法返回该路由处理程序所属的控制器的类。<br>执行上下文有两个重要作用：</li>
</ul>
<ol>
<li>提供不同上下文的参数检索对象（HttpArgumentsHost，WsArgumentsHost）</li>
<li>让我们可以在上下文对象中获取在路由处理程序中添加的元数据</li>
</ol>
<p>作用一已在上文中说明，下面介绍作用二。</p>
<h4 id="添加元数据"><a href="#添加元数据" class="headerlink" title="添加元数据"></a>添加元数据</h4><p>Nest 提供了将自定义元数据附加到路由处理程序的能力，可以通过 <code>Reflector</code> 创建的装饰器，以及内置的 <code>@SetMetadata()</code> 装饰器来实现。<br>创建一个装饰器文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g d roles decorators --flat</span><br></pre></td></tr></table></figure>
<h5 id="Reflector"><a href="#Reflector" class="headerlink" title="Reflector"></a>Reflector</h5><p>Reflector 创建强类型装饰器，我们需要指定类型参数。例如，让我们创建一个 Roles 装饰器，它接受一个字符串数组作为参数。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Reflector &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Roles = Reflector.createDecorator&lt;<span class="built_in">string</span>[]&gt;();</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@Roles</span>([<span class="string">&#x27;admin&#x27;</span>])</span><br><span class="line"><span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.catsService.create(createCatDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，<code>admin</code> 就被附加到了 <code>create</code> 这个路由处理程序上。</p>
<h5 id="SetMetadata"><a href="#SetMetadata" class="headerlink" title="SetMetadata"></a>SetMetadata</h5><p>创建一个装饰器：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; SetMetadata &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Roles = <span class="function">(<span class="params">...roles: <span class="built_in">string</span>[]</span>) =&gt;</span> SetMetadata(<span class="string">&#x27;roles&#x27;</span>, roles);</span><br></pre></td></tr></table></figure>
<p>与 Reflector 的不同之处在于，我们可以对元数据键和值进行更多控制，并且还可以创建接受多个参数的装饰器。<br>使用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>()</span><br><span class="line"><span class="meta">@Roles</span>(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"><span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.catsService.create(createCatDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取元数据"><a href="#获取元数据" class="headerlink" title="获取元数据"></a>获取元数据</h4><h5 id="Reflector-1"><a href="#Reflector-1" class="headerlink" title="Reflector"></a>Reflector</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> roles = <span class="built_in">this</span>.reflector.get(Roles, context.getHandler());</span><br></pre></td></tr></table></figure>
<p><code>context</code> 为执行上下文对象。<br>如果 <code>@Roles()</code> 被添加到了控制器上，那么这样获取元数据：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> roles = <span class="built_in">this</span>.reflector.get(Roles, context.getClass());</span><br></pre></td></tr></table></figure>
<p><code>this.reflector</code> 是 Reflector 对象。<br>如果我们在两个级别上都提供了 Roles 元数据：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Roles</span>([<span class="string">&#x27;user&#x27;</span>])</span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;cats&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CatsController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Post</span>()</span><br><span class="line">  <span class="meta">@Roles</span>([<span class="string">&#x27;admin&#x27;</span>])</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.catsService.create(createCatDto);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果将 <code>&quot;user&quot;</code> 视为默认角色，只想知道该路由处理器是否需要 <code>&quot;admin&quot;&quot;</code> 角色，使用以下方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> roles = <span class="built_in">this</span>.reflector.getAllAndOverride(Roles, [context.getHandler(), context.getClass()]);</span><br><span class="line"><span class="comment">// [&quot;admin&quot;]</span></span><br></pre></td></tr></table></figure>
<p>如果想要获取所有的角色，使用以下方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> roles = <span class="built_in">this</span>.reflector.getAllAndMerge(Roles, [context.getHandler(), context.getClass()]);</span><br><span class="line"><span class="comment">// [&quot;user&quot;, &quot;admin&quot;]</span></span><br></pre></td></tr></table></figure>
<h5 id="SetMetadata-1"><a href="#SetMetadata-1" class="headerlink" title="SetMetadata"></a>SetMetadata</h5><p>通过 SetMetadata 添加的元数据也使用 reflector 获取：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> roles = <span class="built_in">this</span>.reflector.get&lt;<span class="built_in">string</span>[]&gt;(<span class="string">&#x27;roles&#x27;</span>, context.getHandler());</span><br></pre></td></tr></table></figure>
<p>不同的是它传入 <code>get</code> 方法的第一个参数是创建时使用的 key。</p>
<h3 id="Guards-守卫"><a href="#Guards-守卫" class="headerlink" title="Guards 守卫"></a>Guards 守卫</h3><p>guards 只有一个责任，它们根据特定的条件（如权限、角色、权限等）来决定路由处理程序是否处理给定的请求，这通常被称为<strong>授权</strong>。<br>中间件也是一个很好的身份验证选择，但它不知道在调用 <code>next()</code> 函数后将执行哪个处理程序。而 guards 可以访问 <code>ExecutionContext</code> 执行上下文，因此它知道接下来要执行什么。</p>
<blockquote>
<p>Guards 在中间件之后，拦截器和管道之前执行。</p>
</blockquote>
<h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>创建一个 guards 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g gu auth guards --flat</span><br></pre></td></tr></table></figure>
<p>guards 需要实现 <code>CanActivate</code> 接口的 <code>canActivate</code> 方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CanActivate, ExecutionContext, Injectable &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">    canActivate(context: ExecutionContext): <span class="built_in">boolean</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>canActivate</code> 方法的参数是执行上下文，它应该返回一个布尔值，表示当前请求是否被允许。它也可以通过 通过 <code>Promise</code> 或 <code>Observable</code> 异步地返回一个布尔值。</p>
<ul>
<li>返回 <code>true</code>，请求将被处理</li>
<li>返回 <code>false</code>，请求将被拒绝，Nest 会自动返回 403。如果想返回一个不同的错误响应，抛出自定义异常<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4>假如现在我们使用了 JWT 去做身份验证，其颁发的 token 中包含了用户的角色：admin 和 user，我们需要在 guards 中验证 token 的正确性和时效性，以及角色是否有权访问当前路由。<br>要知道当前路由绑定了什么角色，需要用到上节学到的知识：执行上下文。<br>比如现在有这样两个路由：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Post</span>(<span class="string">&#x27;create&#x27;</span>)</span><br><span class="line"><span class="meta">@Roles</span>([<span class="string">&#x27;admin&#x27;</span>])</span><br><span class="line"><span class="function"><span class="title">create</span>(<span class="params"><span class="meta">@Body</span>() createCatDto: CreateCatDto</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.catsService.create(createCatDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Get</span>(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line"><span class="meta">@Roles</span>([<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>])</span><br><span class="line"><span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.catsService.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>/create</code> 路由只允许 admin 访问，<code>/list</code> 路由允许 admin 和 user 访问。<br>接下来定义 guards：<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CanActivate, ExecutionContext, Injectable &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Reflector &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UnauthorizedException &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtService &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/jwt&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Roles &#125; <span class="keyword">from</span> <span class="string">&quot;../decorator/roles.decorator&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGuard</span> <span class="title">implements</span> <span class="title">CanActivate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">private</span> reflector: Reflector,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">private</span> jwtService: JwtService</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    canActivate(context: ExecutionContext): <span class="built_in">boolean</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | Observable&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> request = context.switchToHttp().getRequest&lt;Request&gt;();</span><br><span class="line">        <span class="keyword">const</span> token = request.headers.authorization;</span><br><span class="line">        <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> role: <span class="built_in">string</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            role = <span class="built_in">this</span>.jwtService.verify(token).role;</span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> roles = <span class="built_in">this</span>.reflector.get(Roles, context.getHandler());</span><br><span class="line">        <span class="keyword">if</span> (!roles || roles.includes(role)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4>guards 可以在方法级别（路由处理器）、类级别（控制器）和全局级别使用。<h5 id="方法级别"><a href="#方法级别" class="headerlink" title="方法级别"></a>方法级别</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="meta">@UseGuards</span>(AuthGuard)</span><br><span class="line"><span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="类级别"><a href="#类级别" class="headerlink" title="类级别"></a>类级别</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"><span class="meta">@UseGuards</span>(AuthGuard)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> NestFactory.create(AppModule);</span><br><span class="line">app.useGlobalGuards(<span class="keyword">new</span> AuthGuard());</span><br></pre></td></tr></table></figure>
但这种方式无法进行依赖注入，因此，可以在任意模块中将其作为 provider 供全局使用。<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;auth-guard&quot;</span>,</span><br><span class="line">      <span class="attr">useClass</span>: AuthGuard</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Interceptors-拦截器"><a href="#Interceptors-拦截器" class="headerlink" title="Interceptors 拦截器"></a>Interceptors 拦截器</h3>拦截器有以下几个功能：</li>
</ul>
<ol>
<li>在函数执行之前/之后添加额外逻辑</li>
<li>转换从函数返回的结果</li>
<li>转换函数引发的异常</li>
<li>扩展基本功能</li>
<li>根据特定条件完全覆盖函数（例如，用于缓存）</li>
</ol>
<p>这里的”函数“指的是路由处理程序。</p>
<h4 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4><p>创建一个拦截器文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nest g itc custom interceptors --flat</span><br></pre></td></tr></table></figure>
<p>拦截器需要实现 <code>NestInterceptor</code> 的 <code>intercept</code> 方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CallHandler, ExecutionContext, Injectable, NestInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">    intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> next.handle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>intercept</code> 方法的第一个参数是执行上下文，第二个参数是一个回调函数，<code>CallHandler.handle()</code> 是当前的路由处理程序，如果它没被调用，路由程序方法就不会执行。<br>在调用 <code>CallHandler.handle()</code> 之前的代码逻辑实现了前向拦截，那如何实现后向拦截呢？由于 <code>CallHandler.handle()</code> 返回一个 <code>Observable</code>，因此我们可以使用 <a target="_blank" rel="noopener" href="https://rxjs.dev/">RxJS</a> 操作符来操作响应。</p>
<h5 id="tap-操作符：打印日志"><a href="#tap-操作符：打印日志" class="headerlink" title="tap 操作符：打印日志"></a>tap 操作符：打印日志</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CallHandler, ExecutionContext, Injectable, NestInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">    intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> next.handle().pipe(</span><br><span class="line">            tap(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="map-操作符：修改响应数据"><a href="#map-操作符：修改响应数据" class="headerlink" title="map 操作符：修改响应数据"></a>map 操作符：修改响应数据</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CallHandler, ExecutionContext, Injectable, NestInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, map &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">    intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> next.handle().pipe(</span><br><span class="line">            tap(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">            &#125;),</span><br><span class="line">            map(<span class="function">(<span class="params">data</span>) =&gt;</span> (&#123; ...data, <span class="attr">statusCode</span>: <span class="number">400</span> &#125;))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="catchError-操作符：覆盖异常"><a href="#catchError-操作符：覆盖异常" class="headerlink" title="catchError 操作符：覆盖异常"></a>catchError 操作符：覆盖异常</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CallHandler, ExecutionContext, ForbiddenException, Injectable, NestInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable, throwError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap, map, catchError &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs/operators&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">    intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> next.handle().pipe(</span><br><span class="line">            tap(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">            &#125;),</span><br><span class="line">            map(<span class="function">(<span class="params">data</span>) =&gt;</span> (&#123; ...data, <span class="attr">statusCode</span>: <span class="number">400</span> &#125;)),</span><br><span class="line">            catchError(<span class="function">() =&gt;</span> throwError(<span class="function">() =&gt;</span> <span class="keyword">new</span> ForbiddenException()))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建操作符：覆盖流"><a href="#创建操作符：覆盖流" class="headerlink" title="创建操作符：覆盖流"></a>创建操作符：覆盖流</h5><p>有时候我们想在不调用事件处理程序的情况下返回响应，那么就不能调用 <code>CallHandler.handle()</code> 方法，但是需要返回一个 <code>Observable</code> 对象，这时就可以使用创建操作符去创建一个新的 <code>Observable</code> 对象并返回。<br>常见的创建操作符有 <code>of</code>、<code>from</code>、<code>empty</code> 等等。<br>假如我们设置了缓存，如果缓存时间没到，则不触发路由处理程序，直接返回缓存中的内容，否则通过路由处理程序返回。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; CallHandler, ExecutionContext, Injectable, NestInterceptor &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Observable, throwError, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&quot;rxjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Reflector &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; CacheService &#125; <span class="keyword">from</span> <span class="string">&quot;./cache.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomInterceptor</span> <span class="title">implements</span> <span class="title">NestInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">private</span> reflector: Reflector,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">private</span> cacheService: CacheService</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    intercept(context: ExecutionContext, <span class="attr">next</span>: CallHandler): Observable&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> caches = <span class="built_in">this</span>.reflector.get(Caches, context.getHandler());</span><br><span class="line">        <span class="keyword">const</span> &#123; isExpired, cacheData &#125; = <span class="built_in">this</span>.cacheService.get(caches[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (isCached) <span class="keyword">return</span> <span class="keyword">of</span>(&#123;</span><br><span class="line">            <span class="attr">statusCode</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">data</span>: cacheData</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> next.handle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><p>与 Guards 一样，拦截器也有三个作用域：路由处理程序、控制器、全局。</p>
<h5 id="路由处理程序"><a href="#路由处理程序" class="headerlink" title="路由处理程序"></a>路由处理程序</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Get</span>()</span><br><span class="line"><span class="meta">@UseInterceptors</span>(CustomInterceptor)</span><br><span class="line"><span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UseInterceptors</span>(CustomInterceptor)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="全局-1"><a href="#全局-1" class="headerlink" title="全局"></a>全局</h5><p>在任意模块中作为 provider 供全局使用。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="string">&quot;custom-interceptor&quot;</span>,</span><br><span class="line">      <span class="attr">useClass</span>: CustomInterceptor</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>觉得本文对你有用的话，不妨打个赏吧~</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="Silence 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Silence 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Silence
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/2025/03/15/nest/nest%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/" title="NestJS 核心技术">http://example.com/2025/03/15/nest/nest核心功能/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/node/" rel="tag"><i class="fa fa-tag"></i> node</a>
              <a href="/tags/nest/" rel="tag"><i class="fa fa-tag"></i> nest</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/03/15/nest/nest%E4%BB%8B%E7%BB%8D/" rel="prev" title="NestJS 介绍">
                  <i class="fa fa-chevron-left"></i> NestJS 介绍
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/03/15/nest/nest%E6%89%A9%E5%B1%95/" rel="next" title="NestJS 扩展">
                  NestJS 扩展 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Silence</span>
</div>


<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>



<!--
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>-->



    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>




  <script async src="/js/cursor/fireworks.js"></script>

  
 
	<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
 

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/assets/hijiki.model.json"},"display":{"position":"right"},"mobile":{"show":true},"react":{"opacity":1},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

